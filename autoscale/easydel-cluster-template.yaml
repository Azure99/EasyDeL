cluster_name: { { NAME } }

max_workers: 1024

provider:
  type: gcp
  region: { { REGION } }
  availability_zone: { { ZONE } }
  project_id: { { PROJECT_ID } }

docker:
  image: "ghcr.io/erfanzar/easydel:latest-tpu"
  container_name: "ray_docker"
  pull_before_run: true
  worker_run_options:
    - --privileged
    - --ulimit memlock=-1:-1
    - --shm-size=32gb
    - -e TPU_WORKER_ID
    - -v "/tmp:/tmp"
    - -v "/var/run/docker.sock:/var/run/docker.sock"
  head_run_options:
    - --privileged
    - -v "/tmp:/tmp"
    - --ulimit nofile=1048576:1048576
    - -e RAY_TPU_MAX_CONCURRENT_ACTIVE_CONNECTIONS=64

initialization_commands:
  - gcloud config set project {{PROJECT_ID}}
  - gcloud config set compute/region {{REGION}}
  - gcloud config set compute/zone {{ZONE}}
  - yes | gcloud auth configure-docker {{REGION}}-docker.pkg.dev
  - "export TPU_WORKER_ID=$(curl -H 'Metadata-Flavor: Google' http://metadata.google.internal/computeMetadata/v1/instance/attributes/agent-worker-number) || true"
  - which docker || (curl -fsSL https://get.docker.com -o get-docker.sh; sudo sh get-docker.sh; sudo usermod -aG docker $USER; sudo systemctl restart docker -f)
  - sudo usermod -aG docker $USER
  - sudo chmod 666 /var/run/docker.sock

head_setup_commands:
  - mkdir $HOME/.cache/huggingface -p
  - gcloud secrets versions access latest --secret=HF_TOKEN > $HOME/.cache/huggingface/token || true

worker_setup_commands:
  - mkdir $HOME/.cache/huggingface -p
  - gcloud secrets versions access latest --secret=HF_TOKEN > $HOME/.cache/huggingface/token || true

head_node_type: head_default

available_node_types:
  head_default:
    min_workers: 0
    max_workers: 0
    resources: { "CPU": 0, "head_node": 1 }

    node_config:
      machineType: n2-standard-8
      disks:
        - boot: true
          autoDelete: true
          type: PERSISTENT
          initializeParams:
            diskSizeGb: 200

            sourceImage: projects/ubuntu-os-cloud/global/images/family/ubuntu-2204-lts
